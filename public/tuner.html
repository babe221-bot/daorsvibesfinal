<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Instrument Tuner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base Styles & Modern Theme --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* slate-900 */
            color: #cbd5e1; /* slate-300 */
        }

        /* --- Main Tuner Display (The Dial) --- */
        .tuner-display {
            width: 300px;
            height: 300px;
            border: 4px solid #334155; /* slate-700 */
            border-radius: 50%;
            position: relative;
            margin: 2rem auto;
            background: radial-gradient(circle, #1e293b, #0f172a); /* slate-800 to slate-900 */
            box-shadow: 0 0 30px rgba(20, 211, 211, 0.2), inset 0 0 15px rgba(51, 65, 85, 0.8);
        }

        /* --- The Needle --- */
        .needle {
            width: 3px; /* Slightly thicker */
            height: 140px;
            background-color: #f59e0b; /* amber-500 (out of tune) */
            position: absolute;
            bottom: 50%;
            left: calc(50% - 1.5px);
            transform-origin: bottom;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1); /* Smoother transition */
            border-radius: 3px;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.7);
        }

        /* --- Ticks on the Dial --- */
        .tick {
            position: absolute;
            width: 2px;
            height: 8px;
            background-color: #64748b; /* slate-500 */
            top: 2px;
            left: calc(50% - 1px);
            border-radius: 2px;
        }
        .tick-label {
            position: absolute;
            font-size: 11px;
            color: #94a3b8; /* slate-400 */
            top: 18px;
            transform: translateX(-50%);
            font-weight: 600;
        }

        /* --- Text Displays --- */
        .note-display {
            font-size: 4.5rem; /* Larger note */
            font-weight: 700;
            color: #e2e8f0; /* slate-200 */
            text-shadow: 0 0 10px rgba(20, 211, 211, 0.3);
        }
        .freq-display {
            font-size: 1.25rem;
            color: #94a3b8; /* slate-400 */
        }

        /* --- Status Light --- */
        .status-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #334155; /* slate-700 */
            transition: all 0.3s;
        }
        .status-light.active {
            background-color: #14d3d3; /* cyan-500 */
            box-shadow: 0 0 10px #14d3d3;
        }

        /* --- Custom Styles for Form Elements --- */
        .target-note-selector {
            background-color: #1e293b; /* slate-800 */
            border: 1px solid #475569; /* slate-600 */
            color: #cbd5e1; /* slate-300 */
            padding: 10px;
            border-radius: 8px;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        /* --- Modern Segmented Control for Mode Switch --- */
        .tuner-mode-switch {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            background-color: #1e293b; /* slate-800 */
            border-radius: 8px;
            padding: 4px;
            border: 1px solid #334155; /* slate-700 */
        }
        .tuner-mode-switch label {
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
            color: #94a3b8; /* slate-400 */
            font-weight: 600;
        }
        .tuner-mode-switch input[type="radio"] {
            display: none;
        }
        .tuner-mode-switch input[type="radio"]:checked + label {
            background-color: #334155; /* slate-700 */
            color: #f1f5f9; /* slate-100 */
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="text-center mb-8">
        <h1 id="app-title" class="text-3xl md:text-4xl font-bold text-slate-100 mb-2">AI Instrument Tuner</h1>
        <p id="app-description" class="text-slate-400 max-w-md">Select a target note and hit 'Start' to begin tuning.</p>
    </div>

    <div class="bg-slate-800/50 backdrop-blur-sm p-6 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-sm">
        
        <!-- Tuner Mode Switch -->
        <div class="tuner-mode-switch">
            <input type="radio" id="drum-mode" name="tuner-mode" value="drum" checked>
            <label for="drum-mode">Drum</label>
            <input type="radio" id="guitar-mode" name="tuner-mode" value="guitar">
            <label for="guitar-mode">Guitar</label>
        </div>

        <div class="flex items-center justify-center space-x-3 mb-4">
            <label for="target-note" class="text-slate-300 font-semibold">Target Note:</label>
            <select id="target-note" class="target-note-selector">
                <!-- Options will be populated by JavaScript -->
            </select>
        </div>

        <div class="tuner-display" id="tuner-display-visual">
            <div class="needle" id="needle"></div>
            <!-- Ticks will be populated by JavaScript -->
        </div>

        <div class="text-center my-4">
            <div id="note-display" class="note-display">--</div>
            <div id="freq-display" class="freq-display">0.00 Hz</div>
        </div>

        <div class="flex items-center justify-center space-x-4">
            <div id="status-light" class="status-light"></div>
            <button id="start-btn" class="bg-teal-500 hover:bg-teal-600 disabled:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">Start</button>
            <button id="stop-btn" class="bg-slate-600 hover:bg-slate-700 disabled:bg-slate-700/50 disabled:text-slate-500 text-slate-200 font-bold py-3 px-6 rounded-lg transition-colors" disabled>Stop</button>
        </div>
    </div>
    
    <div id="error-message" class="mt-4 text-red-400 text-center"></div>


    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <script>
        // DOM Elements
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const noteDisplay = document.getElementById('note-display');
        const freqDisplay = document.getElementById('freq-display');
        const needle = document.getElementById('needle');
        const statusLight = document.getElementById('status-light');
        const targetNoteSelector = document.getElementById('target-note');
        const errorMessage = document.getElementById('error-message');
        const tunerDisplay = document.getElementById('tuner-display-visual');
        const appTitle = document.getElementById('app-title');
        const appDescription = document.getElementById('app-description');
        const modeSwitches = document.querySelectorAll('input[name="tuner-mode"]');

        // Audio processing variables
        let mic, analyser;
        let isTuning = false;
        let currentMode = 'drum';
        const noteStrings = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        
        // --- Note presets for different modes ---
        const notePresets = {
            drum: [
                { value: 'G3', text: 'G3 (Snare)' },
                { value: 'C3', text: 'C3 (High Tom)' },
                { value: 'G2', text: 'G2 (Low Tom)' },
                { value: 'E2', text: 'E2 (Kick)' }
            ],
            guitar: [
                { value: 'autodetect', text: 'Autodetect' },
                { value: 'E4', text: 'E4 (1st string)' },
                { value: 'B3', text: 'B3 (2nd string)' },
                { value: 'G3', text: 'G3 (3rd string)' },
                { value: 'D3', text: 'D3 (4th string)' },
                { value: 'A2', text: 'A2 (5th string)' },
                { value: 'E2', text: 'E2 (6th string)' }
            ]
        };
        const guitarNoteFrequencies = notePresets.guitar.filter(n => n.value !== 'autodetect').map(n => ({ ...n, freq: noteToFreq(n.value) }));


        // --- Initialization ---
        
        // Function to set the tuner mode and update UI accordingly
        function setTunerMode(mode) {
            currentMode = mode;
            if (isTuning) stopTuning();

            // Update title and description
            if (mode === 'drum') {
                appTitle.textContent = 'AI Drum Tuner';
                appDescription.textContent = "Select a target drum note and hit 'Start' to begin tuning.";
            } else {
                appTitle.textContent = 'AI Guitar Tuner';
                appDescription.textContent = "Select a target string, or use Autodetect, and hit 'Start'.";
            }

            // Populate the target note dropdown
            targetNoteSelector.innerHTML = '';
            notePresets[mode].forEach(note => {
                const option = document.createElement('option');
                option.value = note.value;
                option.textContent = note.text;
                targetNoteSelector.appendChild(option);
            });
            resetDisplay();
        }

        // Function to initialize audio
        async function initializeAudio() {
            try {
                await Tone.start();
                mic = new Tone.UserMedia();
                await mic.open();
                
                analyser = new Tone.Analyser('fft', 2048); // Increased FFT size for more accuracy
                mic.connect(analyser);

                console.log("Microphone and analyser are ready.");
                errorMessage.textContent = "";
                return true;
            } catch (error) {
                console.error("Error initializing audio:", error);
                errorMessage.textContent = "Could not access microphone. Please allow microphone access in your browser settings.";
                return false;
            }
        }

        // --- Event Listeners ---
        modeSwitches.forEach(switchEl => {
            switchEl.addEventListener('change', (e) => {
                setTunerMode(e.target.value);
            });
        });

        startBtn.addEventListener('click', async () => {
            if (await initializeAudio()) {
                isTuning = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                statusLight.classList.add('active');
                modeSwitches.forEach(s => s.disabled = true);
                targetNoteSelector.disabled = true;
                tuningLoop();
            }
        });

        stopBtn.addEventListener('click', stopTuning);

        function stopTuning() {
            isTuning = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            statusLight.classList.remove('active');
            modeSwitches.forEach(s => s.disabled = false);
            targetNoteSelector.disabled = false;
            if (mic) {
                mic.close();
            }
            resetDisplay();
        }

        // --- Core Logic ---

        // Main tuning loop
        function tuningLoop() {
            if (!isTuning) return;

            const fftData = analyser.getValue();
            const sampleRate = mic && mic.context ? mic.context.sampleRate : 44100;
            const fundamentalFreq = findFundamentalFreq(fftData, sampleRate);
            
            if (fundamentalFreq > 0) {
                const noteData = freqToNote(fundamentalFreq);
                updateUI(noteData, fundamentalFreq);
            }

            requestAnimationFrame(tuningLoop);
        }

        // Find fundamental frequency from FFT data
        function findFundamentalFreq(fftData, sampleRate) {
            let maxVal = -Infinity;
            let maxIndex = -1;

            for (let i = 1; i < fftData.length; i++) {
                if (fftData[i] > maxVal) {
                    maxVal = fftData[i];
                    maxIndex = i;
                }
            }
            
            if (maxVal < -70) { // Adjusted amplitude threshold
                return 0;
            }

            const freq = maxIndex * sampleRate / (analyser.size * 2);

            if (freq > 50 && freq < 1200) {
                 return freq;
            }
            return 0;
        }

        // Convert frequency to note and calculate cents difference
        function freqToNote(freq) {
            let targetNoteName = targetNoteSelector.value;

            // Autodetect logic for guitar
            if (currentMode === 'guitar' && targetNoteName === 'autodetect') {
                targetNoteSelector.disabled = false; // Allow changing strings while autodetecting
                let closestNote = null;
                let smallestDiff = Infinity;
                
                guitarNoteFrequencies.forEach(noteInfo => {
                    const diff = Math.abs(freq - noteInfo.freq);
                    if (diff < smallestDiff) {
                        smallestDiff = diff;
                        closestNote = noteInfo.value;
                    }
                });

                if (closestNote) {
                    targetNoteName = closestNote;
                    // Visually select the detected note in the dropdown
                    if (targetNoteSelector.value !== targetNoteName) {
                       targetNoteSelector.value = targetNoteName;
                    }
                } else {
                   targetNoteName = 'E4'; // Default fallback
                }
            }

            const noteNum = 12 * (Math.log(freq / 440) / Math.log(2));
            const roundedNoteNum = Math.round(noteNum) + 69;
            const noteName = noteStrings[roundedNoteNum % 12];
            const octave = Math.floor(roundedNoteNum / 12) - 1;
            
            const targetFreq = noteToFreq(targetNoteName);
            const centsOff = 1200 * Math.log2(freq / targetFreq);

            return { name: noteName, octave: octave, cents: centsOff };
        }
        
        // Convert note name (e.g., "A4") to frequency
        function noteToFreq(note) {
            const noteParts = note.match(/([A-G]#?)([0-9])/);
            if (!noteParts) return 0;
            const keyNumber = noteStrings.indexOf(noteParts[1]);
            const octave = parseInt(noteParts[2], 10);
            const semiTone = (octave - 4) * 12 + keyNumber - 9;
            return 440 * Math.pow(2, semiTone / 12);
        }

        // --- UI Updates ---

        // Update UI elements with new data
        function updateUI(noteData, freq) {
            noteDisplay.textContent = `${noteData.name}${noteData.octave}`;
            freqDisplay.textContent = `${freq.toFixed(2)} Hz`;

            let rotation = noteData.cents * 0.9; 
            rotation = Math.max(-45, Math.min(45, rotation));
            needle.style.transform = `rotate(${rotation}deg)`;

            // Change needle color based on tuning accuracy
            if (Math.abs(noteData.cents) < 5) { // In tune
                needle.style.backgroundColor = '#14d3d3'; // teal-400
                needle.style.boxShadow = '0 0 15px #14d3d3';
            } else { // Out of tune
                needle.style.backgroundColor = '#f59e0b'; // amber-500
                needle.style.boxShadow = '0 0 10px #f59e0b';
            }
        }
        
        // Reset display to its default state
        function resetDisplay() {
            noteDisplay.textContent = '--';
            freqDisplay.textContent = '0.00 Hz';
            needle.style.transform = 'rotate(0deg)';
            needle.style.backgroundColor = '#f59e0b'; // amber-500
            needle.style.boxShadow = '0 0 10px #f59e0b';
        }
        
        // Add ticks to the tuner display dynamically
        function createTunerTicks() {
            // Clear previous ticks but keep the original needle element
            const existingNeedle = document.getElementById('needle');
            tunerDisplay.innerHTML = '';
            tunerDisplay.appendChild(existingNeedle);

            for (let i = -4; i <= 4; i++) {
                const angle = i * 11;
                const tickContainer = document.createElement('div');
                tickContainer.style.cssText = `position: absolute; width: 100%; height: 100%; transform: rotate(${angle}deg);`;
                
                const tick = document.createElement('div');
                tick.className = 'tick';
                if (i === 0) {
                    tick.style.height = '15px';
                    tick.style.backgroundColor = '#cbd5e1'; // slate-300
                }
                
                const tickLabel = document.createElement('div');
                tickLabel.className = 'tick-label';
                tickLabel.textContent = i * 10;
                tickLabel.style.transform = `rotate(${-angle}deg) translateX(-50%)`;
                
                tickContainer.appendChild(tick);
                if (i % 2 === 0) {
                    tickContainer.appendChild(tickLabel);
                }
                tunerDisplay.appendChild(tickContainer);
            }
        }
        
        // --- Initial Setup on Page Load ---
        window.onload = () => {
            createTunerTicks();
            setTunerMode('drum'); // Default to drum mode
        };

    </script>
</body>
</html>